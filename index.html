<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>ExpenseTracker Pro</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <link rel="icon" type="image/png" href="image.png">

  <section class="style">
  <style id="app-style">
    :root {
      --primary-color: #f44336;
      --primary-hover: #d32f2f;
      --light-gray: #f5f5f5;
      --medium-gray: #e0e0e0;
      --dark-gray: #757575;
      --text-color: #212121;
    }
    
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      transition: background-color 0.3s, color 0.3s;
      color: var(--text-color);
    }
    
    body.dark-mode {
      background-color: #181a1b;
      color: #e0e0e0;
    }
    
    body.dark-mode .card {
      background-color: #23272b;
      border-color: #333;
      color: #e0e0e0;
      box-shadow: 0 2px 10px rgba(0,0,0,0.25);
    }
    
    body.dark-mode .table {
      color: #000000;
      background-color: #23272b;
    }
    
    body.dark-mode .table-striped > tbody > tr:nth-of-type(odd) {
      background-color: #23272b;
    }
    
    body.dark-mode .form-control,
    body.dark-mode .form-select {
      background-color: #23272b;
      border-color: #444;
      color: #e0e0e0;
    }
    
    body.dark-mode .form-control:focus,
    body.dark-mode .form-select:focus {
      background-color: #23272b;
      color: #fff;
      border-color: #f44336;
      box-shadow: 0 0 0 0.2rem rgba(244,67,54,.25);
    }
    
    .app-header {
      background-color: white;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      padding: 15px 0;
      position: sticky;
      top: 0;
      z-index: 1000;
    }
    
    body.dark-mode .app-header {
      background-color: #23272b;
      box-shadow: 0 2px 4px rgba(0,0,0,0.4);
    }
    
    .brand {
      font-size: 1.5rem;
      font-weight: 600;
    }
    
    .theme-toggle {
      cursor: pointer;
      padding: 5px;
      border-radius: 50%;
      width: 36px;
      height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
      background-color: var(--light-gray);
      border: none;
    }
    
    body.dark-mode .theme-toggle {
      background-color: #333;
    }
    
    .btn-primary {
      background-color: var(--primary-color);
      border-color: var(--primary-color);
    }
    
    .btn-primary:hover {
      background-color: var(--primary-hover);
      border-color: var(--primary-hover);
    }
    
    .card {
      margin-bottom: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
      overflow: hidden;
    }
    
    .card-header {
      background-color: white;
      border-bottom: 1px solid var(--medium-gray);
      padding: 15px 20px;
      font-weight: 600;
    }
    
    body.dark-mode .card-header {
      background-color: #23272b;
      border-color: #333;
      color: #fff;
    }
    
    .invalid-feedback {
      display: none;
      color: var(--primary-color);
      font-size: 0.875rem;
    }
    
    .form-control.is-invalid ~ .invalid-feedback {
      display: block;
    }
    
    .table-container {
      overflow-x: auto;
    }
    
    .table-striped > tbody > tr:nth-of-type(odd) {
      background-color: var(--light-gray);
    }
    
    .editable-cell {
      position: relative;
      cursor: pointer;
    }
    
    .editable-cell:hover::after {
      content: "\f044";
      font-family: "Font Awesome 6 Free";
      font-weight: 900;
      position: absolute;
      right: 5px;
      color: var(--dark-gray);
    }
    
    .delete-icon {
      color: var(--primary-color);
      cursor: pointer;
    }
    
    .nav-tabs .nav-link {
      color: var(--dark-gray);
    }
    
    .nav-tabs .nav-link.active {
      color: var(--primary-color);
      font-weight: 600;
    }
    
    body.dark-mode .nav-tabs .nav-link {
      color: #bbb;
      background-color: #23272b;
    }
    
    body.dark-mode .nav-tabs .nav-link.active {
      color: #f44336;
      background-color: #181a1b;
      border-color: #333;
    }
    
    .loading-spinner {
      display: none;
      margin: 10px auto;
    }
    
    .loading-spinner.show {
      display: block;
    }
    
    .preview-table {
      font-size: 0.9rem;
    }
    
    .footer {
      background-color: var(--light-gray);
      padding: 15px 0;
      margin-top: 20px;
      box-shadow: 0 -2px 4px rgba(0, 0, 0, 0.05);
    }
    
    body.dark-mode .footer {
      background-color: #23272b;
      color: #e0e0e0;
      box-shadow: 0 -2px 4px rgba(0,0,0,0.3);
    }
    
    .help-icon {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background-color: var(--primary-color);
      color: white;
      width: 50px;
      height: 50px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
      cursor: pointer;
      z-index: 1000;
    }
    
    body.dark-mode .help-icon {
      background-color: #f44336;
      color: #fff;
      box-shadow: 0 2px 10px rgba(0,0,0,0.4);
    }
    
    .modal-content {
      background-color: #23272b;
      color: #e0e0e0;
    }
    
    .modal-header,
    .modal-footer {
      background-color: #181a1b;
      border-color: #333;
    }
    
    .form-label {
      font-weight: 500;
      color: #e0e0e0;
    }
    
    .collapsible-card .card-body {
      transition: max-height 0.3s ease-out;
      overflow: hidden;
    }
    
    .collapsible-card.collapsed .card-body {
      max-height: 0;
      padding-top: 0;
      padding-bottom: 0;
    }
    
    .collapsible-card .toggle-icon {
      transition: transform 0.3s;
    }
    
    .collapsible-card.collapsed .toggle-icon {
      transform: rotate(180deg);
    }
    
    .chart-container {
      height: 300px;
      margin-bottom: 15px;
    }
    
    .badge-success {
      background-color: #4caf50;
      color: white;
    }

    /* Loader moderno para la gráfica de categorías */
    .category-loader-overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(255,255,255,0.85);
      z-index: 2;
      transition: opacity 0.4s;
      opacity: 1;
      border-radius: 8px;
    }
    .dark-mode .category-loader-overlay {
      background: rgba(34,34,34,0.85);
    }
    .loader-modern {
      width: 3.5rem;
      height: 3.5rem;
      border-width: 0.45em;
      box-shadow: 0 0 16px 0 rgba(67,160,71,0.3);
    }
    .loader-text {
      font-size: 1.15rem;
      font-weight: 500;
      color: #222;
      letter-spacing: 0.5px;
      text-shadow: 0 1px 4px rgba(0,0,0,0.07);
    }
    .dark-mode .loader-text {
      color: #eee;
      text-shadow: 0 1px 6px rgba(0,0,0,0.18);
    }
    .category-loader-overlay.d-none {
      opacity: 0;
      pointer-events: none;
    }


    /* Forzar visibilidad y tamaño mínimo a los canvas de gráficas pie */
    canvas#incomeBarChart, canvas#categoryChart {
      min-width: 300px !important;
      min-height: 300px !important;
      width: 100% !important;
      height: 300px !important;
      display: block !important;

    }
    
    .badge-error {
      background-color: var(--primary-color);
      color: white;
    }
    
    .filter-input {
      max-width: 100px;
      font-size: 0.8rem;
      padding: 2px 5px;
    }
    
    /* Sidebar retractable styles */
    .sidebar {
      width: 240px;
      min-width: 240px;
      max-width: 240px;
      background: #fff;
      color: #212121;
      height: 100vh;
      position: fixed;
      left: 0;
      top: 0;
      bottom: 0;
      z-index: 2000;
      display: flex;
      flex-direction: column;
      transition: width 0.2s cubic-bezier(.4,0,.2,1);
      box-shadow: 2px 0 10px rgba(0,0,0,0.05);
    }
    .sidebar-collapsed {
      width: 72px !important;
      min-width: 72px !important;
      max-width: 72px !important;
    }
    .sidebar .sidebar-logo {
      display: flex;
      align-items: center;
      padding: 24px 24px 12px 24px;
      font-size: 1.4rem;
      font-weight: 600;
      gap: 10px;
      transition: padding 0.2s;
    }
    .sidebar-collapsed .sidebar-logo span {
      display: none;
    }
    .sidebar-collapsed .sidebar-logo {
      justify-content: center;
      padding-left: 0;
      padding-right: 0;
    }
    .sidebar .sidebar-nav {
      flex: 1 1 auto;
      display: flex;
      flex-direction: column;
      gap: 6px;
      padding: 0 8px;
      margin-top: 8px;
    }
    .sidebar .sidebar-nav .nav-item {
      display: flex;
      align-items: center;
      gap: 16px;
      padding: 10px 16px;
      border-radius: 8px;
      cursor: pointer;
      transition: background 0.15s;
      font-size: 1.07rem;
      white-space: nowrap;
    }
    .sidebar .sidebar-nav .nav-item.active {
      background: var(--primary-color);
      color: #fff;
    }
    .sidebar .sidebar-nav .nav-item i {
      min-width: 22px;
      text-align: center;
      font-size: 1.2rem;
    }
    .sidebar-collapsed .sidebar-nav .nav-item span {
      display: none;
    }
    .sidebar-collapsed .sidebar-nav .nav-item {
      justify-content: center;
      padding-left: 0;
      padding-right: 0;
    }
    .sidebar .sidebar-footer {
      padding: 16px 16px 12px 16px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      align-items: flex-start;
    }
    .sidebar-collapsed .sidebar-footer {
      align-items: center;
      padding-left: 0;
      padding-right: 0;
    }
    .sidebar .sidebar-toggle {
      border: none;
      background: none;
      color: #757575;
      font-size: 1.2rem;
      cursor: pointer;
      margin-bottom: 8px;
      transition: color 0.15s;
      padding: 6px 0;
      width: 100%;
      display: flex;
      align-items: center;
      gap: 10px;
      justify-content: flex-start;
    }
    .sidebar-collapsed .sidebar-toggle {
      justify-content: center;
      gap: 0;
    }
    .sidebar .sidebar-toggle span {
      font-size: 1rem;
    }
    .sidebar-collapsed .sidebar-toggle span {
      display: none;
    }
    .sidebar .theme-toggle {
      align-self: flex-start;
    }
    .sidebar-collapsed .theme-toggle {
      align-self: center;
    }
    /* Main content margin for sidebar */
    .main-content {
      margin-left: 240px;
      transition: margin-left 0.2s cubic-bezier(.4,0,.2,1);
    }
    .sidebar-collapsed ~ .main-content {
      margin-left: 72px;
    }
    @media (max-width: 991.98px) {
      .sidebar {
        position: fixed;
        left: 0;
        top: 0;
        height: 100vh;
        z-index: 2000;
        width: 200px;
        min-width: 200px;
        max-width: 200px;
      }
      .sidebar-collapsed {
        width: 56px !important;
        min-width: 56px !important;
        max-width: 56px !important;
      }
      .main-content {
        margin-left: 200px;
      }
      .sidebar-collapsed ~ .main-content {
        margin-left: 56px;
      }
    }
    body.dark-mode .sidebar {
      background: #23272b;
      color: #e0e0e0;
      box-shadow: 2px 0 10px rgba(0,0,0,0.15);
    }
    body.dark-mode .sidebar .sidebar-nav .nav-item.active {
      background: var(--primary-hover);
      color: #fff;
    }
    body.dark-mode .sidebar .sidebar-toggle {
      color: #aaa;
    }
    /* Spinner color in dark mode */
    body.dark-mode .spinner-border {
      border-color: #f44336 #23272b #23272b #23272b;
    }
    
    body.dark-mode .filter-input {
      background-color: #23272b;
      color: #e0e0e0;
      border: 1px solid #444;
      box-shadow: none;
    }
    body.dark-mode .filter-input:focus {
      background-color: #23272b;
      color: #fff;
      border-color: #f44336;
      box-shadow: 0 0 0 0.2rem rgba(244,67,54,.25);
    }
  </style>
  </section>

</head>
<body>
  <!-- Encabezado -->
  <header class="app-header">
    <div class="container">
      <div class="d-flex justify-content-between align-items-center">
        <div class="d-flex align-items-center">
          <img src="image.png" alt="Logo" style="height:36px;width:36px;margin-right:10px; border-radius:50%; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
          background-color: #000000;">
          <div class="brand">ExpenseTracker Pro</div>
        </div>
        <button class="theme-toggle" id="themeToggle">
          <i class="fas fa-moon"></i>
        </button>
      </div>
    </div>
  </header>

  <!-- Contenido principal -->
  <main class="container my-4">
    <div class="row">
      <!-- Panel izquierdo -->
      <div class="col-lg-5 mb-4">
        <!-- Apartado de ingresos en monedas -->
        <div class="card mb-4">
          <div class="card-header">Ingresos en monedas</div>
          <div class="card-body">
            <form id="coinIncomeForm">
              <div class="mb-3">
                <label for="coinType" class="form-label">Tipo de moneda</label>
                <select class="form-select" id="coinType" required>
                  <option value="" selected disabled>Selecciona tipo</option>
                  <option value="1000">$1.000</option>
                  <option value="500">$500</option>
                  <option value="200">$200</option>
                  <option value="100">$100</option>
                  <option value="50">$50</option>
                </select>
              </div>
              <div class="mb-3">
                <label for="coinQuantity" class="form-label">Cantidad</label>
                <input type="number" class="form-control" id="coinQuantity" min="1" placeholder="Cantidad de monedas" required>
              </div>
              <button type="submit" class="btn btn-success w-100">Agregar ingreso</button>
            </form>
            <hr>
            <h6 class="mt-3">Ingresos registrados</h6>
            <div class="table-responsive">
              <table class="table table-striped table-hover" id="coinIncomeTable">
                <thead>
                  <tr>
                    <th>Moneda</th>
                    <th>Cantidad</th>
                    <th>Total</th>
                    <th>Acciones</th>
                  </tr>
                </thead>
                <tbody id="coinIncomeBody">
                  <!-- Ingresos de monedas -->
                </tbody>
                <tfoot>
                  <tr>
                    <th colspan="2" class="text-end">Total general:</th>
                    <th id="coinIncomeTotal">$0</th>
                    <th></th>
                  </tr>
                </tfoot>
              </table>
            </div>
            <button id="printCoinIncomeBtn" class="btn btn-outline-primary w-100 mt-2">Imprimir ingresos</button>
            <button id="saveCoinTableImageBtn" class="btn btn-outline-success w-100 mt-2">Guardar tabla de monedas como imagen</button>
          </div>
        </div>

        <!-- Apartado de ingresos en billetes -->
        <div class="card mb-4">
          <div class="card-header">Ingresos en billetes</div>
          <div class="card-body">
            <form id="billIncomeForm">
              <div class="mb-3">
                <label for="billType" class="form-label">Tipo de billete</label>
                <select class="form-select" id="billType" required>
                  <option value="" selected disabled>Selecciona tipo</option>
                  <option value="2000">$2.000</option>
                  <option value="5000">$5.000</option>
                  <option value="10000">$10.000</option>
                  <option value="20000">$20.000</option>
                  <option value="50000">$50.000</option>
                  <option value="100000">$100.000</option>
                </select>
              </div>
              <div class="mb-3">
                <label for="billQuantity" class="form-label">Cantidad</label>
                <input type="number" class="form-control" id="billQuantity" min="1" placeholder="Cantidad de billetes" required>
              </div>
              <button type="submit" class="btn btn-success w-100">Agregar ingreso</button>
            </form>
            <hr>
            <h6 class="mt-3">Ingresos registrados</h6>
            <div class="table-responsive">
              <table class="table table-striped table-hover" id="billIncomeTable">
                <thead>
                  <tr>
                    <th>Billete</th>
                    <th>Cantidad</th>
                    <th>Total</th>
                    <th>Acciones</th>
                  </tr>
                </thead>
                <tbody id="billIncomeBody">
                  <!-- Ingresos de billetes -->
                </tbody>
                <tfoot>
                  <tr>
                    <th colspan="2" class="text-end">Total general:</th>
                    <th id="billIncomeTotal">$0</th>
                    <th></th>
                  </tr>
                </tfoot>
              </table>
            </div>
            <button id="printBillIncomeBtn" class="btn btn-outline-primary w-100 mt-2">Imprimir ingresos billetes</button>
            <button id="saveBillTableImageBtn" class="btn btn-outline-success w-100 mt-2">Guardar tabla de billetes como imagen</button>
          </div>
        </div>

        <script>
// Lógica para ingresos en billetes (antes en billIncomes.js)
const billTypes = [
  2000, 5000, 10000, 20000, 50000, 100000, 200000, 500000, 1000000
];

function getBillLabel(value) {
  return `$${value.toLocaleString('es-CO')}`;
}

function getBillIncomes() {
  return JSON.parse(localStorage.getItem('billIncomes')) || [];
}

function setBillIncomes(bills) {
  localStorage.setItem('billIncomes', JSON.stringify(bills));
}

function addOrUpdateBillIncome(type, quantity) {
  let bills = getBillIncomes();
  const idx = bills.findIndex(b => b.type === type);
  if (idx !== -1) {
    bills[idx].quantity += quantity;
  } else {
    bills.push({ type, quantity });
  }
  setBillIncomes(bills);
}

function deleteBillIncome(type) {
  let bills = getBillIncomes();
  bills = bills.filter(b => b.type !== type);
  setBillIncomes(bills);
}

function updateBillIncome(type, quantity) {
  let bills = getBillIncomes();
  const idx = bills.findIndex(b => b.type === type);
  if (idx !== -1) {
    bills[idx].quantity = quantity;
    setBillIncomes(bills);
  }
}

function getBillTotal() {
  return getBillIncomes().reduce((sum, b) => sum + b.type * b.quantity, 0);
}

// Export para uso global
window.billTypes = billTypes;
window.getBillLabel = getBillLabel;
window.getBillIncomes = getBillIncomes;
window.setBillIncomes = setBillIncomes;
window.addOrUpdateBillIncome = addOrUpdateBillIncome;
window.deleteBillIncome = deleteBillIncome;
window.updateBillIncome = updateBillIncome;
window.getBillTotal = getBillTotal;
</script>

        <!-- Tarjeta para agregar gasto -->
        <div class="card">
          <div class="card-header">
            Agregar gasto
          </div>
          <div class="card-body">
            <form id="expenseForm">
              <div class="mb-3">
                <label for="expenseDate" class="form-label">Fecha</label>
                <input type="text" class="form-control" id="expenseDate" placeholder="Selecciona fecha">
                <div class="invalid-feedback">Por favor selecciona una fecha válida.</div>
              </div>
              <div class="mb-3">
                <label for="expenseCategory" class="form-label">Categoría</label>
                <select class="form-select" id="expenseCategory">
                  <option value="" selected disabled>Selecciona categoría</option>
                  <option value="Food">Alimentación</option>
                  <option value="Transportation">Transporte</option>
                  <option value="Housing">Vivienda</option>
                  <option value="Utilities">Servicios</option>
                  <option value="Entertainment">Entretenimiento</option>
                  <option value="Shopping">Compras</option>
                  <option value="Healthcare">Salud</option>
                  <option value="Travel">Viajes</option>
                  <option value="Education">Educación</option>
                  <option value="Other">Otro</option>
                </select>
                <div class="invalid-feedback">Por favor selecciona una categoría.</div>
              </div>
              <div class="mb-3">
                <label for="expenseDescription" class="form-label">Descripción</label>
                <input type="text" class="form-control" id="expenseDescription" placeholder="Ingresa descripción">
                <div class="invalid-feedback">Por favor ingresa una descripción.</div>
              </div>
              <div class="mb-3">
                <label for="expenseAmount" class="form-label">Monto</label>
                <div class="input-group">
                  <span class="input-group-text">$</span>
                  <input type="number" class="form-control" id="expenseAmount" placeholder="0.00" step="0.01" min="0">
                </div>
                <div class="invalid-feedback">Por favor ingresa un monto válido.</div>
              </div>
              <button type="submit" class="btn btn-primary w-100">Agregar gasto</button>
            </form>
          </div>
        </div>
        
        <!-- Tarjeta para importar desde imagen -->
        <div class="card collapsible-card" style="left: 2px; top: -8px;">
          <div class="card-header d-flex justify-content-between align-items-center" role="button" data-bs-toggle="collapse" href="#importImageCollapse">
            <span>Importar desde imagen</span>
            <i class="fas fa-chevron-up toggle-icon"></i>
          </div>
          <div class="card-body" id="importImageCollapse">
            <div class="mb-3">
              <label for="importImageFile" class="form-label">Selecciona una imagen de tu tabla impresa</label>
              <input class="form-control" type="file" id="importImageFile" accept="image/*">
              <small class="text-muted">Formatos soportados: .jpg, .jpeg, .png, .webp</small>
            </div>
            <div id="importedImagePreview" class="mb-2" style="display:none;">
              <h6 class="mt-3 mb-2">Vista previa de la imagen importada</h6>
              <img id="importedImage" src="" alt="Imagen importada" style="max-width:100%;border:1px solid #ccc;padding:4px;">
            </div>
            <div id="importImageStatus"></div>
          </div>
        </div>
      </div>
      
      <!-- Panel derecho -->
      <div class="col-lg-7">
        <div class="card" style="top: -1px; left: 9px;">
          <div class="card-header p-0">
            <ul class="nav nav-tabs" id="visualizationTabs" role="tablist">
              <li class="nav-item" role="presentation">
                <button class="nav-link active" id="dashboard-tab" data-bs-toggle="tab" data-bs-target="#dashboard" type="button" role="tab" aria-controls="dashboard" aria-selected="true">Dashboard</button>
              </li>
              <li class="nav-item" role="presentation">
                <button class="nav-link" id="data-table-tab" data-bs-toggle="tab" data-bs-target="#dataTable" type="button" role="tab" aria-controls="dataTable" aria-selected="false">Tabla de datos</button>
              </li>
            </ul>
          </div>
          <div class="card-body">
            <div class="tab-content" id="visualizationTabsContent">
              <!-- Pestaña Dashboard -->
              <div class="tab-pane fade show active" id="dashboard" role="tabpanel" aria-labelledby="dashboard-tab">
                <div class="row">
                  <!-- Gráfico mensual -->
                  <div class="col-md-12 mb-4">
                    <div class="card">
                      <div class="card-header">
                        Gasto mensual
                      </div>
                      <div class="card-body">
                        <div class="chart-container">
                          <div class="d-none justify-content-center align-items-center h-100" id="monthlyChartLoader">
                            <div class="spinner-border text-primary" role="status">
                              <span class="visually-hidden">Cargando...</span>
                            </div>
                          </div>
                          <canvas id="monthlyChart"></canvas>
                        </div>
                      </div>
                    </div>
                  </div>
                  
                  <!-- Gráfico por categoría -->
                  <div class="col-md-6 mb-4">
                    <div class="card">
                      <div class="card-header">
                        Distribución por categoría
                      </div>
                      <div class="card-body">
                        <div class="chart-container">
                          <canvas id="categoryChart"></canvas>
                        </div>
                      </div>
                    </div>
                  </div>

                  
                  
                  <!-- Gráfico acumulado -->
                  <div class="col-md-6 mb-4">
                    <div class="card" style="left: -2px; top: -5px;">
                      <div class="card-header">
                        Gasto acumulado en el tiempo
                      </div>
                      <div class="card-body">
                        <div class="chart-container">
                          <div class="d-none justify-content-center align-items-center h-100" id="timelineChartLoader">
                            <div class="spinner-border text-primary" role="status">
                              <span class="visually-hidden">Cargando...</span>
                            </div>
                          </div>
                          <canvas id="timelineChart"></canvas>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              
              <!-- Pestaña Tabla de datos -->
              <div class="tab-pane fade" id="dataTable" role="tabpanel" aria-labelledby="data-table-tab">
                <div class="table-container">
                  <table class="table table-striped table-hover" id="expensesTable">
                    <thead>
                      <tr>
                        <th>
                          Fecha
                          <div><input type="text" class="form-control form-control-sm filter-input" id="dateFilter" placeholder="Filtrar"></div>
                        </th>
                        <th>
                          Categoría
                          <div><input type="text" class="form-control form-control-sm filter-input" id="categoryFilter" placeholder="Filtrar"></div>
                        </th>
                        <th>
                          Descripción
                          <div><input type="text" class="form-control form-control-sm filter-input" id="descriptionFilter" placeholder="Filtrar"></div>
                        </th>
                        <th>
                          Monto
                          <div><input type="text" class="form-control form-control-sm filter-input" id="amountFilter" placeholder="Filtrar"></div>
                        </th>
                        <th>Acciones</th>
                      </tr>
                    </thead>
                    <tbody id="expensesTableBody">
                      <!-- Los datos de gastos se insertarán aquí dinámicamente en español -->
                    </tbody>
                  </table>
                </div>
                <div class="d-flex justify-content-between align-items-center mt-3">
                  <div>
                    <span>Mostrando <span id="currentRows">0</span> de <span id="totalRows">0</span> registros</span>
                  </div>
                  <nav aria-label="Navegación de la tabla de gastos">
                    <ul class="pagination pagination-sm" id="tablePagination">
                      <!-- Los enlaces de paginación se insertarán aquí -->
                    </ul>
                  </nav>
                </div>
                <div class="d-flex gap-2">
                  <button id="printExpensesBtn" class="btn btn-outline-primary w-100 mt-2">Imprimir gastos</button>
                  <button id="saveTableImageBtn" class="btn btn-outline-success w-100 mt-2">Guardar tabla como imagen</button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- Pie de página -->
  <footer class="footer">
    <div class="container">
      <div class="d-flex justify-content-between align-items-center">
        <div>
          <strong>Total de gastos: </strong>
          <span id="totalExpenses">$0.00</span>
          <span class="ms-3"><strong>Total este año:</strong> <span id="totalYear">$0.00</span></span>
        </div>
        <button id="resetAllBtn" class="btn btn-outline-danger">Reiniciar todo</button>
        <button id="printAllBtn" class="btn btn-outline-primary ms-2">Imprimir todo</button>
      </div>
    </div>
  </footer>

  <!-- Toast de éxito -->
  <div class="position-fixed bottom-0 end-0 p-3" style="z-index: 1100">
    <div id="successToast" class="toast align-items-center text-bg-success border-0" role="alert" aria-live="assertive" aria-atomic="true">
      <div class="d-flex">
        <div class="toast-body">
          <i class="fas fa-check-circle me-2"></i> ¡Gasto agregado exitosamente!
        </div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Cerrar"></button>
      </div>
    </div>
  </div>

  <!-- Icono de ayuda -->
  <div class="help-icon" data-bs-toggle="modal" data-bs-target="#helpModal">
    <i class="fas fa-question"></i>
  </div>

  <!-- Modal de ayuda -->
  <div class="modal fade" id="helpModal" tabindex="-1" aria-labelledby="helpModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="helpModalLabel">Cómo usar ExpenseTracker Pro</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
        </div>
        <div class="modal-body">
          <h6>Agregar gastos</h6>
          <p>Completa el formulario a la izquierda con los detalles del gasto y haz clic en "Agregar gasto".</p>
          
          <h6>Importar gastos</h6>
          <p>Puedes importar gastos desde una imagen de tu tabla impresa. Usa el botón "Guardar tabla como imagen" para descargar la tabla generada y luego impórtala usando "Importar desde imagen". Se mostrará la vista previa de la imagen seleccionada.</p>
          
          <h6>Ver datos</h6>
          <p>Cambia entre la pestaña "Dashboard" para ver los gráficos y "Tabla de datos" para ver y editar tus gastos.</p>
          
          <h6>Editar datos</h6>
          <p>En la tabla, haz clic en cualquier celda para editar su contenido. Haz clic en el icono de papelera para eliminar un registro.</p>
          <h6>Exportar tabla como imagen</h6>
          <p>Puedes guardar la tabla de gastos como imagen haciendo clic en el botón "Guardar tabla como imagen". Luego podrás importarla en otro momento usando la opción de imagen.</p>
          
          <h6>Filtrar y ordenar</h6>
          <p>Usa los filtros en la parte superior de cada columna para filtrar datos. Haz clic en los encabezados para ordenar.</p>
          
          <h6>Reiniciar datos</h6>
          <p>Haz clic en el botón "Reiniciar todo" en el pie de página para borrar todos los datos de gastos.</p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Dependencias -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  
  <section class="js">
  <script id="app-script">
// --- Lógica para ingresos en billetes ---
function updateBillIncomeTable() {
  const billIncomeBody = document.getElementById('billIncomeBody');
  const billIncomeTotal = document.getElementById('billIncomeTotal');
  let bills = window.getBillIncomes();
  billIncomeBody.innerHTML = '';
  let total = 0;
  bills.forEach((b, idx) => {
    const subtotal = b.type * b.quantity;
    total += subtotal;
    const tr = document.createElement('tr');
    // Billete
    const tdBillete = document.createElement('td');
    tdBillete.textContent = window.getBillLabel(b.type);
    tr.appendChild(tdBillete);
    // Cantidad (editable)
    const tdCantidad = document.createElement('td');
    tdCantidad.textContent = b.quantity;
    tdCantidad.style.cursor = 'pointer';
    tdCantidad.addEventListener('click', function() {
      const input = document.createElement('input');
      input.type = 'number';
      input.className = 'form-control form-control-sm';
      input.value = b.quantity;
      input.min = '1';
      tdCantidad.innerHTML = '';
      tdCantidad.appendChild(input);
      input.focus();
      input.select();
      input.addEventListener('blur', function() {
        const newVal = parseInt(this.value);
        if (!isNaN(newVal) && newVal > 0) {
          window.updateBillIncome(b.type, newVal);
          updateBillIncomeTable();
        } else {
          updateBillIncomeTable();
        }
      });
      input.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') this.blur();
      });
    });
    tr.appendChild(tdCantidad);
    // Total
    const tdTotal = document.createElement('td');
    tdTotal.textContent = window.getBillLabel(subtotal);
    tr.appendChild(tdTotal);
    // Botón eliminar
    const tdDelete = document.createElement('td');
    const deleteBtn = document.createElement('i');
    deleteBtn.className = 'fas fa-trash delete-icon';
    deleteBtn.style.cursor = 'pointer';
    deleteBtn.title = 'Eliminar ingreso';
    deleteBtn.addEventListener('click', function() {
      window.deleteBillIncome(b.type);
      updateBillIncomeTable();
    });
    tdDelete.appendChild(deleteBtn);
    tr.appendChild(tdDelete);
    billIncomeBody.appendChild(tr);
  });
  billIncomeTotal.textContent = window.getBillLabel(total);
}

document.addEventListener('DOMContentLoaded', function() {
  // Inicializar tabla y eventos de ingresos en billetes
  updateBillIncomeTable();
  const billIncomeForm = document.getElementById('billIncomeForm');
  const billType = document.getElementById('billType');
  const billQuantity = document.getElementById('billQuantity');
  billIncomeForm.addEventListener('submit', function(e) {
    e.preventDefault();
    const type = parseInt(billType.value);
    const quantity = parseInt(billQuantity.value);
    if (!type || isNaN(quantity) || quantity <= 0) return;
    window.addOrUpdateBillIncome(type, quantity);
    updateBillIncomeTable();
    billIncomeForm.reset();
  });
  // Botón imprimir billetes
  document.getElementById('printBillIncomeBtn').addEventListener('click', function() {
    let html = `<h2 style='text-align:center;'>Ingresos en billetes</h2>`;
    html += `<table border='1' cellspacing='0' cellpadding='5' style='width:100%;margin:20px 0;text-align:center;'>`;
    html += `<tr><th>Billete</th><th>Cantidad</th><th>Valor por billete</th><th>Total</th></tr>`;
    let total = 0;
    window.getBillIncomes().forEach(b => {
      const subtotal = b.type * b.quantity;
      total += subtotal;
      html += `<tr><td>${window.getBillLabel(b.type)}</td><td>${b.quantity}</td><td>${window.getBillLabel(b.type)}</td><td>${window.getBillLabel(subtotal)}</td></tr>`;
    });
    html += `<tr><th colspan='3' style='text-align:right;'>Total general:</th><th>${window.getBillLabel(total)}</th></tr>`;
    html += `</table>`;
    const win = window.open('', '', 'width=900,height=700');
    win.document.write(`<html><head><title>Ingresos en billetes</title></head><body>${html}</body></html>`);
    win.document.close();
    win.print();
  });
  // Botón guardar tabla de billetes como imagen
  document.getElementById('saveBillTableImageBtn').addEventListener('click', function() {
    const table = document.getElementById('billIncomeTable');
    if (!table) {
      alert('No se encontró la tabla de billetes.');
      return;
    }
    html2canvas(table).then(canvas => {
      const link = document.createElement('a');
      link.download = 'tabla_billetes.png';
      link.href = canvas.toDataURL('image/png');
      link.click();
    });
  });
});
// --- Fin lógica billetes ---

    // --- Imprimir todo: gastos, monedas, billetes, dashboard ---
    document.addEventListener('DOMContentLoaded', function() {
      document.getElementById('printAllBtn').addEventListener('click', async function() {
        // --- Mostrar todos los registros de las tablas antes de imprimir ---
        // Guardar el estado actual de paginación y datos
        let originalRowsPerPage = window.rowsPerPage;
        let originalCurrentPage = window.currentPage;
        let originalExpenses = window.expenses ? [...window.expenses] : [];
        let filteredExpenses = window.expenses ? [...window.expenses] : [];
        // Mostrar todos los gastos
        window.rowsPerPage = 1000000;
        if (typeof updateExpensesTableFiltered === 'function') {
          updateExpensesTableFiltered(filteredExpenses, 1);
        } else if (typeof updateExpensesTable === 'function') {
          updateExpensesTable();
        }
        // Mostrar todos los ingresos en monedas y billetes (si hay paginación)
        if (typeof updateCoinIncomeTable === 'function') updateCoinIncomeTable();
        if (typeof updateBillIncomeTable === 'function') updateBillIncomeTable();

        // --- Asegurarse de que los gráficos estén actualizados y visibles ---
        if (typeof updateCharts === 'function') updateCharts();
        // Activar la pestaña dashboard si no está activa
        const dashboardTab = document.getElementById('dashboard-tab');
        if (dashboardTab && !dashboardTab.classList.contains('active')) {
          dashboardTab.click();
        }
        // Esperar a que los gráficos se rendericen
        await new Promise(res => setTimeout(res, 600));

        // 1. Captura tablas como HTML
        let html = `<h2 style='text-align:center;'>Resumen General</h2>`;
        // Gastos
        const expensesTable = document.getElementById('expensesTable');
        if (expensesTable) {
          html += `<h3 style='text-align:center;'>Gastos</h3>` + expensesTable.outerHTML;
        }
        // Monedas
        const coinTable = document.getElementById('coinIncomeTable');
        if (coinTable) {
          html += `<h3 style='text-align:center;'>Ingresos en monedas</h3>` + coinTable.outerHTML;
        }
        // Billetes
        const billTable = document.getElementById('billIncomeTable');
        if (billTable) {
          html += `<h3 style='text-align:center;'>Ingresos en billetes</h3>` + billTable.outerHTML;
        }
        // 2. Captura gráficas con html2canvas
        let chartImagesHtml = '';
        const chartIds = ['monthlyChart', 'categoryChart', 'timelineChart', 'incomePieChart'];
        for (const id of chartIds) {
          const chartEl = document.getElementById(id);
          if (chartEl) {
            try {
              const canvas = await html2canvas(chartEl.parentElement, {backgroundColor: null});
              const imgData = canvas.toDataURL('image/png');
              chartImagesHtml += `<div style='text-align:center; margin: 30px 0;'><img src='${imgData}' style='max-width:90%;border:1px solid #ccc;'/></div>`;
            } catch (e) {}
          }
        }
        if (chartImagesHtml) {
          html = `<h2 style='text-align:center;'>Dashboard</h2>` + chartImagesHtml + '<hr>' + html;
        }
        // 3. Abrir ventana de impresión
        const win = window.open('', '', 'width=1000,height=900');
        win.document.write(`<html><head><title>Impresión completa</title></head><body>${html}</body></html>`);
        win.document.close();
        win.print();
        // --- Restaurar paginación y vista original ---
        window.rowsPerPage = originalRowsPerPage;
        if (typeof updateExpensesTableFiltered === 'function') {
          updateExpensesTableFiltered(filteredExpenses, originalCurrentPage);
        } else if (typeof updateExpensesTable === 'function') {
          updateExpensesTable();
        }
        if (typeof updateCoinIncomeTable === 'function') updateCoinIncomeTable();
        if (typeof updateBillIncomeTable === 'function') updateBillIncomeTable();
      });


      // Initialize date picker
      flatpickr("#expenseDate", {
        dateFormat: "Y-m-d",
        defaultDate: new Date()
      });
      
      // Initialize collapsible cards
      document.querySelectorAll('.collapsible-card .card-header').forEach(header => {
        header.addEventListener('click', function() {
          const card = this.closest('.collapsible-card');
          card.classList.toggle('collapsed');
        });
      });
      
      // Theme toggle functionality
      const themeToggle = document.getElementById('themeToggle');
      const icon = themeToggle.querySelector('i');
      
      themeToggle.addEventListener('click', function() {
        document.body.classList.toggle('dark-mode');
        
        if (document.body.classList.contains('dark-mode')) {
          icon.classList.remove('fa-moon');
          icon.classList.add('fa-sun');
          localStorage.setItem('theme', 'dark');
        } else {
          icon.classList.remove('fa-sun');
          icon.classList.add('fa-moon');
          localStorage.setItem('theme', 'light');
        }
      });
      
      // Check for saved theme preference
      if (localStorage.getItem('theme') === 'dark') {
        document.body.classList.add('dark-mode');
        icon.classList.remove('fa-moon');
        icon.classList.add('fa-sun');
      }
      
      // Load expenses from localStorage
      let expenses = JSON.parse(localStorage.getItem('expenses')) || [];
      
      // Ingresos en monedas
      let coinIncomes = JSON.parse(localStorage.getItem('coinIncomes')) || [];
      const coinIncomeForm = document.getElementById('coinIncomeForm');
      const coinType = document.getElementById('coinType');
      const coinQuantity = document.getElementById('coinQuantity');
      const coinIncomeBody = document.getElementById('coinIncomeBody');
      const coinIncomeTotal = document.getElementById('coinIncomeTotal');

      coinIncomeForm.addEventListener('submit', function(e) {
        e.preventDefault();
        const type = coinType.value;
        const quantity = parseInt(coinQuantity.value);
        if (!type || isNaN(quantity) || quantity <= 0) return;
        // Buscar si ya existe ese tipo de moneda
        const existing = coinIncomes.find(c => c.type === type);
        if (existing) {
          existing.quantity += quantity;
        } else {
          coinIncomes.push({ type, quantity });
        }
        localStorage.setItem('coinIncomes', JSON.stringify(coinIncomes));
        updateCoinIncomeTable();
        coinIncomeForm.reset();
      });

      function updateCoinIncomeTable() {
        coinIncomeBody.innerHTML = '';
        let total = 0;
        const coinLabels = { '1000': '$1.000', '500': '$500', '200': '$200', '100': '$100', '50': '$50' };
        coinIncomes.forEach((c, idx) => {
          const value = parseInt(c.type);
          const subtotal = value * c.quantity;
          total += subtotal;
          const tr = document.createElement('tr');
          // Moneda
          const tdMoneda = document.createElement('td');
          tdMoneda.textContent = coinLabels[c.type];
          tr.appendChild(tdMoneda);
          // Cantidad (editable)
          const tdCantidad = document.createElement('td');
          tdCantidad.textContent = c.quantity;
          tdCantidad.style.cursor = 'pointer';
          tdCantidad.addEventListener('click', function() {
            const input = document.createElement('input');
            input.type = 'number';
            input.className = 'form-control form-control-sm';
            input.value = c.quantity;
            input.min = '1';
            tdCantidad.innerHTML = '';
            tdCantidad.appendChild(input);
            input.focus();
            input.select();
            input.addEventListener('blur', function() {
              const newVal = parseInt(this.value);
              if (!isNaN(newVal) && newVal > 0) {
                c.quantity = newVal;
                localStorage.setItem('coinIncomes', JSON.stringify(coinIncomes));
                updateCoinIncomeTable();
              } else {
                updateCoinIncomeTable();
              }
            });
            input.addEventListener('keypress', function(e) {
              if (e.key === 'Enter') this.blur();
            });
          });
          tr.appendChild(tdCantidad);
          // Total
          const tdTotal = document.createElement('td');
          tdTotal.textContent = `$${formatNumberWithDots(subtotal)}`;
          tr.appendChild(tdTotal);
          // Botón eliminar
          const tdDelete = document.createElement('td');
          const deleteBtn = document.createElement('i');
          deleteBtn.className = 'fas fa-trash delete-icon';
          deleteBtn.style.cursor = 'pointer';
          deleteBtn.title = 'Eliminar ingreso';
          deleteBtn.addEventListener('click', function() {
            coinIncomes.splice(idx, 1);
            localStorage.setItem('coinIncomes', JSON.stringify(coinIncomes));
            updateCoinIncomeTable();
          });
          tdDelete.appendChild(deleteBtn);
          tr.appendChild(tdDelete);
          coinIncomeBody.appendChild(tr);
        });
        coinIncomeTotal.textContent = `$${formatNumberWithDots(total)}`;
      }
      updateCoinIncomeTable();
      // Mantener sincronizado el gráfico de ingresos
      window.coinIncomes = JSON.parse(localStorage.getItem('coinIncomes')) || [];
      window.addEventListener('storage', function() {
        window.coinIncomes = JSON.parse(localStorage.getItem('coinIncomes')) || [];
        if (window.incomeBarChart) {
          const ctx = document.getElementById('incomeBarChart').getContext('2d');
          const data = processIncomeData();
          window.incomeBarChart.data.labels = data.labels;
          window.incomeBarChart.data.datasets[0].data = data.data;
          window.incomeBarChart.data.datasets[0].backgroundColor = data.colors;
          window.incomeBarChart.data.datasets[0].borderColor = data.borderColors;
          window.incomeBarChart.update();
        }
      });
      // Handle expense form submission
      const expenseForm = document.getElementById('expenseForm');
      expenseForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        // Get form values
        const date = document.getElementById('expenseDate').value;
        const category = document.getElementById('expenseCategory').value;
        const description = document.getElementById('expenseDescription').value;
        const amount = parseFloat(document.getElementById('expenseAmount').value);
        
        // Validate form
        let isValid = true;
        
        if (!date) {
          document.getElementById('expenseDate').classList.add('is-invalid');
          isValid = false;
        } else {
          document.getElementById('expenseDate').classList.remove('is-invalid');
        }
        
        if (!category) {
          document.getElementById('expenseCategory').classList.add('is-invalid');
          isValid = false;
        } else {
          document.getElementById('expenseCategory').classList.remove('is-invalid');
        }
        
        if (!description) {
          document.getElementById('expenseDescription').classList.add('is-invalid');
          isValid = false;
        } else {
          document.getElementById('expenseDescription').classList.remove('is-invalid');
        }
        
        if (isNaN(amount) || amount <= 0) {
          document.getElementById('expenseAmount').classList.add('is-invalid');
          isValid = false;
        } else {
          document.getElementById('expenseAmount').classList.remove('is-invalid');
        }
        
        if (isValid) {
          // Add new expense
          const newExpense = {
            id: Date.now(), // use timestamp as id
            date,
            category,
            description,
            amount
          };
          
          expenses.push(newExpense);
          
          // Save to localStorage
          localStorage.setItem('expenses', JSON.stringify(expenses));
          
          // Update UI
          updateExpensesTable();
          updateCharts();
          updateTotalExpenses();
          
          // Reset form
          expenseForm.reset();
          flatpickr("#expenseDate").setDate(new Date());
          
          // Mostrar mensaje de éxito mejorado (toast)
          const toastEl = document.getElementById('successToast');
          const toast = new bootstrap.Toast(toastEl, { delay: 2500 });
          toast.show();
        }
      });
      
      // Tarjeta de importar imagen
      const importImageFile = document.getElementById('importImageFile');
      const importedImagePreview = document.getElementById('importedImagePreview');
      const importedImage = document.getElementById('importedImage');
      const importImageStatus = document.getElementById('importImageStatus');

      function showImportedImage() {
        const imgData = localStorage.getItem('importedTableImage');
        if (imgData) {
          importedImage.src = imgData;
          importedImagePreview.style.display = '';
        } else {
          importedImagePreview.style.display = 'none';
        }
      }
      showImportedImage();

      if (importImageFile) {
        importImageFile.addEventListener('change', function(e) {
          const file = e.target.files[0];
          if (!file) return;
          if (!file.type.startsWith('image/')) {
            importImageStatus.innerHTML = '<span class="badge bg-danger">El archivo no es una imagen válida.</span>';
            return;
          }
          const reader = new FileReader();
          reader.onload = function(evt) {
            localStorage.setItem('importedTableImage', evt.target.result);
            importedImage.src = evt.target.result;
            importedImagePreview.style.display = '';
            importImageStatus.innerHTML = '<span class="badge bg-success">Imagen importada correctamente.</span>';
          };
          reader.readAsDataURL(file);
        });
      }
      
      // Imprimir ingresos en monedas
      document.getElementById('printCoinIncomeBtn').addEventListener('click', function() {
        let html = `<h2 style='text-align:center;'>Ingresos en monedas</h2>`;
        html += `<table border='1' cellspacing='0' cellpadding='5' style='width:100%;margin:20px 0;text-align:center;'>`;
        html += `<tr><th>Moneda</th><th>Cantidad</th><th>Valor por moneda</th><th>Total</th></tr>`;
        const coinLabels = { '1000': '$1.000', '500': '$500', '200': '$200', '100': '$100', '50': '$50' };
        let total = 0;
        coinIncomes.forEach(c => {
          const value = parseInt(c.type);
          const subtotal = value * c.quantity;
          total += subtotal;
          html += `<tr><td>${coinLabels[c.type]}</td><td>${c.quantity}</td><td>${coinLabels[c.type]}</td><td>$${formatNumberWithDots(subtotal)}</td></tr>`;
        });
        html += `<tr><th colspan='3' style='text-align:right;'>Total general:</th><th>$${formatNumberWithDots(total)}</th></tr>`;
        html += `</table>`;
        const win = window.open('', '', 'width=900,height=700');
        win.document.write(`<html><head><title>Ingresos en monedas</title></head><body>${html}</body></html>`);
        win.document.close();
        win.print();
      });

      // Imprimir gastos
      document.getElementById('printExpensesBtn').addEventListener('click', function() {
        let html = `<h2 style='text-align:center;'>Gastos</h2>`;
        html += `<table border='1' cellspacing='0' cellpadding='5' style='width:100%;margin:20px 0;text-align:center;'>`;
        html += `<tr><th>Fecha</th><th>Categoría</th><th>Descripción</th><th>Monto</th></tr>`;
        let total = 0;
        expenses.forEach(e => {
          html += `<tr><td>${e.date}</td><td>${e.category}</td><td>${e.description}</td><td>$${formatNumberWithDots(e.amount)}</td></tr>`;
          total += e.amount;
        });
        html += `<tr><th colspan='3' style='text-align:right;'>Total general:</th><th>$${formatNumberWithDots(total)}</th></tr>`;
        html += `</table>`;
        const win = window.open('', '', 'width=900,height=700');
        win.document.write(`<html><head><title>Gastos</title></head><body>${html}</body></html>`);
        win.document.close();
        win.print();
      });

      // Guardar tabla de gastos como imagen
      document.getElementById('saveTableImageBtn').addEventListener('click', function() {
        const table = document.getElementById('expensesTable');
        if (!table) {
          alert('No se encontró la tabla de gastos.');
          return;
        }
        html2canvas(table).then(canvas => {
          const link = document.createElement('a');
          link.download = 'tabla_gastos.png';
          link.href = canvas.toDataURL('image/png');
          link.click();
        });
      });

      // Guardar tabla de monedas como imagen
      document.getElementById('saveCoinTableImageBtn').addEventListener('click', function() {
        const table = document.getElementById('coinIncomeTable');
        if (!table) {
          alert('No se encontró la tabla de monedas.');
          return;
        }
        html2canvas(table).then(canvas => {
          const link = document.createElement('a');
          link.download = 'tabla_monedas.png';
          link.href = canvas.toDataURL('image/png');
          link.click();
        });
      });
      
      // Function to format numbers with dot as thousands separator
      function formatNumberWithDots(number) {
        // Convierte a string con separador de miles punto y decimales coma
        if (typeof number !== 'number') number = parseFloat(number);
        if (isNaN(number)) return '';
        return number.toLocaleString('es-CO', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
      }
      
      // Estado de paginación
      let currentPage = 1;
      const rowsPerPage = 5;

      // Function to update expenses table
      function updateExpensesTable() {
        // Aplicar filtros actuales y paginar
        const dateValue = dateFilter.value.toLowerCase();
        const categoryValue = categoryFilter.value.toLowerCase();
        const descriptionValue = descriptionFilter.value.toLowerCase();
        const amountValue = amountFilter.value.toLowerCase();
        const filtered = [...expenses].sort((a, b) => new Date(b.date) - new Date(a.date)).filter(expense => {
          const dateMatch = expense.date.toLowerCase().includes(dateValue);
          const categoryMatch = (expense.category || '').toLowerCase().includes(categoryValue);
          const descriptionMatch = (expense.description || '').toLowerCase().includes(descriptionValue);
          const amountMatch = String(expense.amount).toLowerCase().includes(amountValue);
          return dateMatch && categoryMatch && descriptionMatch && amountMatch;
        });
        updateExpensesTableFiltered(filtered, currentPage);
      }

      function updateExpensesTableFiltered(expenses, page) {
        const tableBody = document.getElementById('expensesTableBody');
        const currentRowsElement = document.getElementById('currentRows');
        const totalRowsElement = document.getElementById('totalRows');
        tableBody.innerHTML = '';
        const startIndex = (page - 1) * rowsPerPage;
        const endIndex = startIndex + rowsPerPage;
        const paginatedExpenses = expenses.slice(startIndex, endIndex);
        paginatedExpenses.forEach(expense => {
          const tr = document.createElement('tr');
          // Fecha
          const dateCell = document.createElement('td');
          dateCell.className = 'editable-cell';
          dateCell.dataset.id = expense.id;
          dateCell.dataset.field = 'date';
          dateCell.textContent = expense.date;
          dateCell.addEventListener('click', function() {
            makeExpenseCellEditable(this, expense, 'date');
          });
          tr.appendChild(dateCell);
          // Categoría (en español)
          const categoryCell = document.createElement('td');
          categoryCell.className = 'editable-cell';
          categoryCell.dataset.id = expense.id;
          categoryCell.dataset.field = 'category';
          const categoryMap = {
            'Food': 'Alimentación',
            'Transportation': 'Transporte',
            'Housing': 'Vivienda',
            'Utilities': 'Servicios',
            'Entertainment': 'Entretenimiento',
            'Shopping': 'Compras',
            'Healthcare': 'Salud',
            'Travel': 'Viajes',
            'Education': 'Educación',
            'Other': 'Otro'
          };
          categoryCell.textContent = categoryMap[expense.category] || expense.category;
          categoryCell.addEventListener('click', function() {
            makeExpenseCellEditable(this, expense, 'category');
          });
          tr.appendChild(categoryCell);
          // Descripción
          const descriptionCell = document.createElement('td');
          descriptionCell.className = 'editable-cell';
          descriptionCell.dataset.id = expense.id;
          descriptionCell.dataset.field = 'description';
          descriptionCell.textContent = expense.description;
          descriptionCell.addEventListener('click', function() {
            makeExpenseCellEditable(this, expense, 'description');
          });
          tr.appendChild(descriptionCell);
          // Monto
          const amountCell = document.createElement('td');
          amountCell.className = 'editable-cell text-end';
          amountCell.dataset.id = expense.id;
          amountCell.dataset.field = 'amount';
          amountCell.textContent = `$${formatNumberWithDots(expense.amount)}`;
          amountCell.addEventListener('click', function() {
            makeExpenseCellEditable(this, expense, 'amount');
          });
          tr.appendChild(amountCell);
          // Acciones
          const actionsCell = document.createElement('td');
          actionsCell.className = 'text-center';
          const deleteIcon = document.createElement('i');
          deleteIcon.className = 'fas fa-trash delete-icon';
          deleteIcon.dataset.id = expense.id;
          deleteIcon.title = 'Eliminar';
          deleteIcon.addEventListener('click', function() {
            const id = this.dataset.id;
            expenses = expenses.filter(expense => expense.id != id);
            localStorage.setItem('expenses', JSON.stringify(expenses));
            updateExpensesTable();
            updateCharts();
            updateTotalExpenses();
          });
          actionsCell.appendChild(deleteIcon);
          tr.appendChild(actionsCell);
          tableBody.appendChild(tr);
        });
        currentRowsElement.textContent = sortedExpenses.length;
        totalRowsElement.textContent = sortedExpenses.length;
      }
      
      function makeExpenseCellEditable(cell, expense, field) {
        const oldValue = field === 'amount' ? expense.amount : expense[field];
        const input = document.createElement(field === 'amount' ? 'input' : 'input');
        input.type = field === 'amount' ? 'number' : 'text';
        input.className = 'form-control form-control-sm';
        input.value = oldValue;
        if (field === 'amount') input.step = '0.01';
        cell.innerHTML = '';
        cell.appendChild(input);
        input.focus();
        input.select();
        input.addEventListener('blur', function() {
          let newValue = input.value;
          if (field === 'amount') {
            newValue = parseFloat(newValue);
            if (isNaN(newValue) || newValue <= 0) {
              updateExpensesTable();
              return;
            }
            expense.amount = newValue;
          } else if (field === 'date') {
            if (!newValue) {
              updateExpensesTable();
              return;
            }
            expense.date = newValue;
          } else if (field === 'category') {
            if (!newValue) {
              updateExpensesTable();
              return;
            }
            expense.category = newValue;
          } else if (field === 'description') {
            expense.description = newValue;
          }
          localStorage.setItem('expenses', JSON.stringify(expenses));
          updateExpensesTable();
          updateCharts();
          updateTotalExpenses();
        });
        input.addEventListener('keypress', function(e) {
          if (e.key === 'Enter') input.blur();
        });
      }
      
      // Function to update total expenses
      function updateTotalExpenses() {
        const totalElement = document.getElementById('totalExpenses');
        const totalYearElement = document.getElementById('totalYear');
        const total = expenses.reduce((sum, expense) => sum + expense.amount, 0);
        const currentYear = new Date().getFullYear();
        const totalYear = expenses.reduce((sum, expense) => {
          const expenseYear = new Date(expense.date).getFullYear();
          return sum + (expenseYear === currentYear ? expense.amount : 0);
        }, 0);
        totalElement.textContent = `$${formatNumberWithDots(total)}`;
        totalYearElement.textContent = `$${formatNumberWithDots(totalYear)}`;
      }
      
      // Function to update charts
      function updateCharts() {
        // Show loaders
        document.getElementById('monthlyChartLoader').style.display = "";
        document.getElementById('timelineChartLoader').style.display = '';
        setTimeout(() => {
          document.getElementById('monthlyChartLoader').style.display = 'none';
          document.getElementById('timelineChartLoader').style.display = 'none';
          const monthlyCtx = document.getElementById('monthlyChart').getContext('2d');
          const categoryCtx = document.getElementById('categoryChart').getContext('2d');
          const timelineCtx = document.getElementById('timelineChart').getContext('2d');
          if (window.monthlyChart && typeof window.monthlyChart.destroy === 'function') window.monthlyChart.destroy();
          if (window.categoryChart && typeof window.categoryChart.destroy === 'function') window.categoryChart.destroy();
          if (window.timelineChart && typeof window.timelineChart.destroy === 'function') window.timelineChart.destroy();
          const monthlyData = processMonthlyData();
          const categoryData = processCategoryData();
          const timelineData = processTimelineData();
          window.monthlyChart = new Chart(monthlyCtx, {
            type: 'bar',
            data: {
              labels: monthlyData.labels,
              datasets: [{
                label: 'Gasto mensual',
                data: monthlyData.data,
                backgroundColor: monthlyData.colors,
                borderColor: monthlyData.borderColors,
                borderWidth: 1
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              locale: 'es-ES',
              scales: {
                y: {
                  beginAtZero: true,
                  title: {
                    display: true,
                    text: 'Monto ($)',
                    color: '#666',
                    font: { family: 'inherit', size: 14, weight: 'bold' }
                  },
                  ticks: {
                    callback: function(value) {
                      return '$' + formatNumberWithDots(value);
                    }
                  }
                },
                x: {
                  title: {
                    display: true,
                    text: 'Mes',
                    color: '#666',
                    font: { family: 'inherit', size: 14, weight: 'bold' }
                  }
                }
              },
              plugins: {
                legend: {
                  display: false,
                  labels: { color: '#666', font: { family: 'inherit', size: 13 } }
                },
                tooltip: {
                  callbacks: {
                    label: function(context) {
                      return 'Gasto: $' + formatNumberWithDots(context.raw);
                    }
                  },
                  titleColor: '#333',
                  bodyColor: '#333',
                  footerColor: '#333'
                },
                  title: {
                    display: false
                  }
                }
              } // <-- Cierra el objeto options
            } // <-- Cierra el objeto pasado a new Chart
          ); // <-- Cierra la llamada a new Chart
          window.timelineChart = new Chart(timelineCtx, {
            type: 'line',
            data: {
              labels: timelineData.labels,
              datasets: [{
                label: 'Gasto acumulado',
                data: timelineData.data,
                backgroundColor: 'rgba(244, 67, 54, 0.2)',
                borderColor: 'rgba(244, 67, 54, 1)',
                borderWidth: 2,
                tension: 0.3,
                fill: true
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              locale: 'es-ES',
              scales: {
                y: {
                  beginAtZero: true,
                  title: {
                    display: true,
                    text: 'Monto acumulado ($)',
                    color: '#666',
                    font: { family: 'inherit', size: 14, weight: 'bold' }
                  },
                  ticks: {
                    callback: function(value) {
                      return '$' + formatNumberWithDots(value);
                    }
                  }
                },
                x: {
                  title: {
                    display: true,
                    text: 'Fecha',
                    color: '#666',
                    font: { family: 'inherit', size: 14, weight: 'bold' }
                  }
                }
              },
              plugins: {
                legend: {
                  display: false,
                  labels: { color: '#666', font: { family: 'inherit', size: 13 } }
                },
                tooltip: {
                  callbacks: {
                    label: function(context) {
                      return 'Acumulado: $' + formatNumberWithDots(context.raw);
                    }
                  },
                  titleColor: '#333',
                  bodyColor: '#333',
                  footerColor: '#333'
                },
                title: {
                  display: false
                }
              }
            }
          });
        }, 500);
      }
      
      // Function to process monthly data for chart
      function processMonthlyData() {
        const months = ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'];
        const monthlyTotals = Array(12).fill(0);
        
        // Get current year
        const currentYear = new Date().getFullYear();
        
        // Calculate monthly totals for current year
        expenses.forEach(expense => {
          const expenseDate = new Date(expense.date);
          if (expenseDate.getFullYear() === currentYear) {
            const month = expenseDate.getMonth();
            monthlyTotals[month] += expense.amount;
          }
        });
        
        // Generate colors
        const colors = monthlyTotals.map(amount => `rgba(244, 67, 54, ${Math.min(0.3 + amount / 1000, 0.9)})`);
        const borderColors = colors.map(color => color.replace('rgba', 'rgb').replace(/[\d.]+\)$/, '1)'));
        
        return {
          labels: months,
          data: monthlyTotals,
          colors,
          borderColors
        };
      }
      
      // Function to process category data for chart
      window.processCategoryData = function processCategoryData() {
        const categoryTotals = {};
        // Mapeo de categorías en español a clave interna
        const categoryKeyMap = {
          'Alimentación': 'Food',
          'Transporte': 'Transportation',
          'Vivienda': 'Housing',
          'Servicios': 'Utilities',
          'Entretenimiento': 'Entertainment',
          'Compras': 'Shopping',
          'Salud': 'Healthcare',
          'Viajes': 'Travel',
          'Educación': 'Education',
          'Otro': 'Other',
          // También permitir claves internas para compatibilidad
          'Food': 'Food',
          'Transportation': 'Transportation',
          'Housing': 'Housing',
          'Utilities': 'Utilities',
          'Entertainment': 'Entertainment',
          'Shopping': 'Shopping',
          'Healthcare': 'Healthcare',
          'Travel': 'Travel',
          'Education': 'Education',
          'Other': 'Other'
        };
        const colorMap = {
          'Food': 'rgba(244, 67, 54, 0.7)',
          'Transportation': 'rgba(33, 150, 243, 0.7)',
          'Housing': 'rgba(76, 175, 80, 0.7)',
          'Utilities': 'rgba(255, 193, 7, 0.7)',
          'Entertainment': 'rgba(156, 39, 176, 0.7)',
          'Shopping': 'rgba(0, 188, 212, 0.7)',
          'Healthcare': 'rgba(233, 30, 99, 0.7)',
          'Travel': 'rgba(255, 87, 34, 0.7)',
          'Education': 'rgba(63, 81, 181, 0.7)',
          'Other': 'rgba(158, 158, 158, 0.7)'
        };
        const categoryLabelMap = {
          'Food': 'Alimentación',
          'Transportation': 'Transporte',
          'Housing': 'Vivienda',
          'Utilities': 'Servicios',
          'Entertainment': 'Entretenimiento',
          'Shopping': 'Compras',
          'Healthcare': 'Salud',
          'Travel': 'Viajes',
          'Education': 'Educación',
          'Other': 'Otro'
        };
        // Get current month and year
        const now = new Date();
        const currentMonth = now.getMonth();
        const currentYear = now.getFullYear();
        // Sumar todas las categorías iguales (en español o inglés)
        expenses.forEach(expense => {
          const expenseDate = new Date(expense.date);
          let key = categoryKeyMap[expense.category] || expense.category;
          if (expenseDate.getMonth() === currentMonth && expenseDate.getFullYear() === currentYear) {
            if (!categoryTotals[key]) {
              categoryTotals[key] = 0;
            }
            categoryTotals[key] += expense.amount;
          }
        });
        // Agrupar por etiqueta en español para sumar correctamente si hay duplicados
        const labelTotals = {};
        Object.keys(categoryTotals).forEach(key => {
          const label = categoryLabelMap[key] || key;
          if (!labelTotals[label]) labelTotals[label] = 0;
          labelTotals[label] += categoryTotals[key];
        });
        const labels = Object.keys(labelTotals);
        const data = Object.values(labelTotals);
        const colors = labels.map(label => {
          // Buscar la key original para el color
          const key = Object.keys(categoryLabelMap).find(k => categoryLabelMap[k] === label) || 'Other';
          return colorMap[key] || 'rgba(158, 158, 158, 0.7)';
        });
        const borderColors = colors.map(color => color.replace('rgba', 'rgb').replace(/\d+\.\d+\)$/, '1)'));
        return {
          labels,
          data,
          colors,
          borderColors
        };
      }
      
      // Function to process timeline data for chart
      function processTimelineData() {
        // Sort expenses by date
        const sortedExpenses = [...expenses].sort((a, b) => new Date(a.date) - new Date(b.date));
        
        // Group by date
        const dailyTotals = {};
        
        sortedExpenses.forEach(expense => {
          if (!dailyTotals[expense.date]) {
            dailyTotals[expense.date] = 0;
          }
          dailyTotals[expense.date] += expense.amount;
        });
        
        // Convert to cumulative totals
        let cumulativeTotal = 0;
        const cumulativeTotals = {};
        
        Object.keys(dailyTotals).sort().forEach(date => {
          cumulativeTotal += dailyTotals[date];
          cumulativeTotals[date] = cumulativeTotal;
        });
        
        // Get dates and cumulative totals
        const labels = Object.keys(cumulativeTotals);
        const data = Object.values(cumulativeTotals);
        
        return {
          labels,
          data
        };
      }
      
      // Initialize table filters
      const dateFilter = document.getElementById('dateFilter');
      const categoryFilter = document.getElementById('categoryFilter');
      const descriptionFilter = document.getElementById('descriptionFilter');
      const amountFilter = document.getElementById('amountFilter');
      
      // Add filter event listeners
      dateFilter.addEventListener('input', filterTable);
      categoryFilter.addEventListener('input', filterTable);
      descriptionFilter.addEventListener('input', filterTable);
      amountFilter.addEventListener('input', filterTable);
      
      function filterTable() {
        const dateValue = dateFilter.value.toLowerCase();
        const categoryValue = categoryFilter.value.toLowerCase();
        const descriptionValue = descriptionFilter.value.toLowerCase();
        const amountValue = amountFilter.value.toLowerCase();

        // Filtrar gastos y paginar
        const filtered = [...expenses].filter(expense => {
          const dateMatch = expense.date.toLowerCase().includes(dateValue);
          const categoryMatch = (expense.category || '').toLowerCase().includes(categoryValue);
          const descriptionMatch = (expense.description || '').toLowerCase().includes(descriptionValue);
          const amountMatch = String(expense.amount).toLowerCase().includes(amountValue);
          return dateMatch && categoryMatch && descriptionMatch && amountMatch;
        });
        // Actualizar tabla con los filtrados y reiniciar a la página 1
        updateExpensesTableFiltered(filtered, 1);
      }

      function updateExpensesTableFiltered(filteredExpenses, page = 1) {
        const tableBody = document.getElementById('expensesTableBody');
        const currentRowsElement = document.getElementById('currentRows');
        const totalRowsElement = document.getElementById('totalRows');
        const paginationElement = document.getElementById('tablePagination');
        tableBody.innerHTML = '';
        const totalRows = filteredExpenses.length;
        const totalPages = Math.ceil(totalRows / rowsPerPage) || 1;
        if (page > totalPages) page = totalPages;
        currentPage = page;
        const startIdx = (currentPage - 1) * rowsPerPage;
        const endIdx = startIdx + rowsPerPage;
        const expensesToShow = filteredExpenses.slice(startIdx, endIdx);

        expensesToShow.forEach(expense => {
          const tr = document.createElement('tr');
          // Fecha
          const dateCell = document.createElement('td');
          dateCell.className = 'editable-cell';
          dateCell.dataset.id = expense.id;
          dateCell.dataset.field = 'date';
          dateCell.textContent = expense.date;
          dateCell.addEventListener('click', function() {
            makeExpenseCellEditable(this, expense, 'date');
          });
          tr.appendChild(dateCell);
          // Categoría (en español)
          const categoryCell = document.createElement('td');
          categoryCell.className = 'editable-cell';
          categoryCell.dataset.id = expense.id;
          categoryCell.dataset.field = 'category';
          const categoryMap = {
            'Food': 'Alimentación',
            'Transportation': 'Transporte',
            'Housing': 'Vivienda',
            'Utilities': 'Servicios',
            'Entertainment': 'Entretenimiento',
            'Shopping': 'Compras',
            'Healthcare': 'Salud',
            'Travel': 'Viajes',
            'Education': 'Educación',
            'Other': 'Otro'
          };
          categoryCell.textContent = categoryMap[expense.category] || expense.category;
          categoryCell.addEventListener('click', function() {
            makeExpenseCellEditable(this, expense, 'category');
          });
          tr.appendChild(categoryCell);
          // Descripción
          const descriptionCell = document.createElement('td');
          descriptionCell.className = 'editable-cell';
          descriptionCell.dataset.id = expense.id;
          descriptionCell.dataset.field = 'description';
          descriptionCell.textContent = expense.description;
          descriptionCell.addEventListener('click', function() {
            makeExpenseCellEditable(this, expense, 'description');
          });
          tr.appendChild(descriptionCell);
          // Monto
          const amountCell = document.createElement('td');
          amountCell.className = 'editable-cell text-end';
          amountCell.dataset.id = expense.id;
          amountCell.dataset.field = 'amount';
          amountCell.textContent = `$${formatNumberWithDots(expense.amount)}`;
          amountCell.addEventListener('click', function() {
            makeExpenseCellEditable(this, expense, 'amount');
          });
          tr.appendChild(amountCell);
          // Acciones
          const actionsCell = document.createElement('td');
          actionsCell.className = 'text-center';
          const deleteIcon = document.createElement('i');
          deleteIcon.className = 'fas fa-trash delete-icon';
          deleteIcon.dataset.id = expense.id;
          deleteIcon.title = 'Eliminar';
          deleteIcon.addEventListener('click', function() {
            const id = this.dataset.id;
            expenses = expenses.filter(exp => exp.id != id);
            localStorage.setItem('expenses', JSON.stringify(expenses));
            filterTable(); // Refiltrar y repaginar
            updateCharts();
            updateTotalExpenses();
          });
          actionsCell.appendChild(deleteIcon);
          tr.appendChild(actionsCell);
          tableBody.appendChild(tr);
        });
        currentRowsElement.textContent = expensesToShow.length;
        totalRowsElement.textContent = totalRows;
        // --- Controles de paginación ---
        if (paginationElement) {
          paginationElement.innerHTML = '';
          // Prev
          const prevLi = document.createElement('li');
          prevLi.className = `page-item${currentPage === 1 ? ' disabled' : ''}`;
          const prevBtn = document.createElement('button');
          prevBtn.className = 'page-link';
          prevBtn.innerHTML = '&laquo;';
          prevBtn.onclick = () => {
            if (currentPage > 1) updateExpensesTableFiltered(filteredExpenses, currentPage - 1);
          };
          prevLi.appendChild(prevBtn);
          paginationElement.appendChild(prevLi);
          // Números
          for (let i = 1; i <= totalPages; i++) {
            const li = document.createElement('li');
            li.className = `page-item${i === currentPage ? ' active' : ''}`;
            const btn = document.createElement('button');
            btn.className = 'page-link';
            btn.textContent = i;
            btn.onclick = () => updateExpensesTableFiltered(filteredExpenses, i);
            li.appendChild(btn);
            paginationElement.appendChild(li);
          }
          // Next
          const nextLi = document.createElement('li');
          nextLi.className = `page-item${currentPage === totalPages ? ' disabled' : ''}`;
          const nextBtn = document.createElement('button');
          nextBtn.className = 'page-link';
          nextBtn.innerHTML = '&raquo;';
          nextBtn.onclick = () => {
            if (currentPage < totalPages) updateExpensesTableFiltered(filteredExpenses, currentPage + 1);
          };
          nextLi.appendChild(nextBtn);
          paginationElement.appendChild(nextLi);
        }
      }

      // Inicializa tabla filtrada al cargar la página
      // window.addEventListener('DOMContentLoaded', () => filterTable());
      
      // Initialize the UI
      updateExpensesTable();
      updateCharts();

      // Inicializa el gráfico de ingresos (barra)
      const incomeBarCanvas = document.getElementById('incomeBarChart');
      if (incomeBarCanvas) {
        if (window.incomeBarChart && typeof window.incomeBarChart.destroy === 'function') window.incomeBarChart.destroy();
        const incomeBarCtx = incomeBarCanvas.getContext('2d');
        let incomeData = processIncomeData();
        console.log('[BarChart] Datos ingresos:', incomeData);
        if (!incomeData.labels.length) {
          console.warn('Sin datos para la gráfica de ingresos. Mostrando ejemplo.');
          incomeData = {
            labels: ['Ejemplo 1', 'Ejemplo 2'],
            data: [60, 40],
            colors: ['#4caf50', '#f44336'],
            borderColors: ['#388e3c', '#b71c1c']
          };
        }
        window.incomeBarChart = new Chart(incomeBarCtx, {
          type: 'bar',
          data: {
            labels: incomeData.labels,
            datasets: [{
              label: 'Ingresos',
              data: incomeData.data,
              backgroundColor: incomeData.colors,
              borderColor: incomeData.borderColors,
              borderWidth: 1
            }]
          },
          options: {
            responsive: true,
            plugins: {
              legend: { display: false },
              tooltip: {
                callbacks: {
                  label: function(context) {
                    return `${context.label}: $${context.raw.toLocaleString('es-CO')}`;
                  }
                }
              },
              title: { display: false }
            },
            scales: {
              y: {
                beginAtZero: true,
                title: {
                  display: true,
                  text: 'Monto ($)',
                  color: '#666',
                  font: { family: 'inherit', size: 14, weight: 'bold' }
                },
                ticks: {
                  callback: function(value) {
                    return '$' + value.toLocaleString('es-CO');
                  }
                }
              },
              x: {
                title: {
                  display: true,
                  text: 'Tipo de ingreso',
                  color: '#666',
                  font: { family: 'inherit', size: 14, weight: 'bold' }
                }
              }
            }
          }
        });
      } else {
        console.error('No existe el canvas de ingresos (incomeBarChart)');
      }

      // Inicializa el gráfico de categorías (pie)
      const categoryPieCanvas = document.getElementById('categoryChart');
      if (categoryPieCanvas) {
        // Elimina el loader antes de crear la gráfica para evitar parpadeos o demoras visuales
        const loader = document.getElementById('categoryChartLoader');
        if (loader) loader.classList.add('d-none');
        if (window.categoryPieChart && typeof window.categoryPieChart.destroy === 'function') window.categoryPieChart.destroy();
        const categoryPieCtx = categoryPieCanvas.getContext('2d');
        let categoryData = processCategoryData();
        console.log('[PieChart] Datos categorías:', categoryData);
        if (!categoryData.labels.length) {
          console.warn('Sin datos para la gráfica de categorías. Mostrando ejemplo.');
          categoryData = {
            labels: ['Ejemplo A', 'Ejemplo B', 'Ejemplo C'],
            data: [30, 50, 20],
            colors: ['#2196f3', '#ff9800', '#9c27b0'],
            borderColors: ['#1565c0', '#e65100', '#4a148c']
          };
        }
        window.categoryPieChart = new Chart(categoryPieCtx, {
          type: 'pie',
          data: {
            labels: categoryData.labels,
            datasets: [{
              data: categoryData.data,
              backgroundColor: [
                '#43a047', '#1e88e5', '#fbc02d', '#e53935', '#8e24aa', '#00acc1', '#f4511e', '#3949ab', '#6d4c41', '#c0ca33', '#5e35b1', '#00897b', '#fdd835', '#fb8c00', '#90a4ae'
              ],
              borderColor: '#fff',
              borderWidth: 3
            }]
          },
          options: {
            responsive: true,
            animation: { animateRotate: true, duration: 400, easing: 'easeOutQuart' }, // Reduce duración animación
            plugins: {
              legend: {
                display: true,
                position: 'top',
                align: 'center',
                labels: {
                  color: document.body.classList.contains('dark-mode') ? '#eee' : '#333',
                  font: { family: 'inherit', size: 14, weight: 'bold' },
                  boxWidth: 20,
                  boxHeight: 20,
                  usePointStyle: true,
                  pointStyle: 'rectRounded',
                  padding: 18
                }
              },
              tooltip: {
                backgroundColor: document.body.classList.contains('dark-mode') ? '#222' : '#fff',
                titleColor: document.body.classList.contains('dark-mode') ? '#fff' : '#222',
                bodyColor: document.body.classList.contains('dark-mode') ? '#fff' : '#222',
                borderColor: '#43a047',
                borderWidth: 2,
                padding: 16,
                titleFont: { size: 18, weight: 'bold', family: 'inherit' },
                bodyFont: { size: 18, weight: 'bold', family: 'inherit' },
                callbacks: {
                  label: function(context) {
                    return `${context.label}: $${context.raw.toLocaleString('es-CO')}`;
                  }
                }
              },
              title: {
                display: true,
                text: 'Category Breakdown',
                color: document.body.classList.contains('dark-mode') ? '#fff' : '#222',
                font: { family: 'inherit', size: 20, weight: 'bold' },
                padding: { top: 10, bottom: 10 }
              }
            }
          }
        });
      } else {
        console.error('No existe el canvas de categorías (categoryChart)');
      }


      // Recarga los dashboards al mostrar la pestaña Dashboard
      document.getElementById('dashboard-tab').addEventListener('shown.bs.tab', function () {
        updateCharts();
        // Refresca el gráfico de ingresos (barra)
        const incomeBarCanvas = document.getElementById('incomeBarChart');
        if (incomeBarCanvas) {
          if (window.incomeBarChart) window.incomeBarChart.destroy();
          const ctx = incomeBarCanvas.getContext('2d');
          const data = processIncomeData();
          window.incomeBarChart = new Chart(ctx, {
            type: 'bar',
            data: {
              labels: data.labels,
              datasets: [{
                label: 'Ingresos',
                data: data.data,
                backgroundColor: data.colors,
                borderColor: data.borderColors,
                borderWidth: 1
              }]
            },
            options: {
              responsive: true,
              plugins: {
                legend: { display: false },
                tooltip: {
                  callbacks: {
                    label: function(context) {
                      return `${context.label}: $${context.raw.toLocaleString('es-CO')}`;
                    }
                  }
                },
                title: { display: false }
              },
              scales: {
                y: {
                  beginAtZero: true,
                  title: {
                    display: true,
                    text: 'Monto ($)',
                    color: '#666',
                    font: { family: 'inherit', size: 14, weight: 'bold' }
                  },
                  ticks: {
                    callback: function(value) {
                      return '$' + value.toLocaleString('es-CO');
                    }
                  }
                },
                x: {
                  title: {
                    display: true,
                    text: 'Tipo de ingreso',
                    color: '#666',
                    font: { family: 'inherit', size: 14, weight: 'bold' }
                  }
                }
              }
            }
          });
        }
        // Refresca el gráfico de categorías (pie)
        const categoryPieCanvas = document.getElementById('categoryChart');
        if (categoryPieCanvas) {
          if (window.categoryPieChart) window.categoryPieChart.destroy();
          const ctx = categoryPieCanvas.getContext('2d');
          const data = processCategoryData();
          window.categoryPieChart = new Chart(ctx, {
            type: 'pie',
            data: {
              labels: data.labels,
              datasets: [{
                data: data.data,
                backgroundColor: data.colors,
                borderColor: data.borderColors,
                borderWidth: 1
              }]
            },
            options: {
              responsive: true,
              plugins: {
                legend: { position: 'bottom', labels: { color: '#666', font: { family: 'inherit', size: 13 } } },
                tooltip: {
                  callbacks: {
                    label: function(context) {
                      const label = context.label || '';
                      const value = context.raw;
                      const total = context.dataset.data.reduce((a, b) => a + b, 0);
                      const percentage = Math.round((value / total) * 100);
                      return `${label}: $${value.toLocaleString('es-AR')} (${percentage}%)`;
                    }
                  }
                },
                title: { display: false }
              }
            }
          });
        }
      });
    });
    
    function initCharts() {
      // Monthly expenses bar chart
      const monthlyCtx = document.getElementById('monthlyExpensesChart').getContext('2d');
      window.monthlyChart = new Chart(monthlyCtx, {
        type: 'bar',
        data: {
          labels: ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'],
          datasets: [{
            label: 'Gastos Mensuales',
            data: [12000, 19000, 15000, 26700, 0, 0, 0, 0, 0, 0, 0, 0],
            backgroundColor: '#FF0000',
            borderColor: '#CC0000',
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                callback: function(value) {
                  return '$' + value.toLocaleString('es-AR');
                }
              }
            }
          }
        }
      });
      // Category pie chart
      const pieCtx = document.getElementById('categoryPieChart').getContext('2d');
      window.pieChart = new Chart(pieCtx, {
        type: 'pie',
        data: {
          labels: ['Alimentación', 'Transporte', 'Vivienda', 'Entretenimiento', 'Salud'],
          datasets: [{
            data: [5000, 2500, 15000, 1200, 3000],
            backgroundColor: [
              '#FF0000',
              '#FF3333',
              '#FF6666',
              '#FF9999',
              '#FFCCCC'
            ],
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            tooltip: {
              callbacks: {
                label: function(context) {
                  const label = context.label || '';
                  const value = context.raw;
                  const total = context.dataset.data.reduce((a, b) => a + b, 0);
                  const percentage = Math.round((value / total) * 100);
                  return `${label}: $${value.toLocaleString('es-AR')} (${percentage}%)`;
                }
              }
            }
          }
        }
      });
      // Cumulative expenses line chart
      const lineCtx = document.getElementById('cumulativeExpensesChart').getContext('2d');
      window.lineChart = new Chart(lineCtx, {
        type: 'line',
        data: {
          labels: ['Ene', 'Feb', 'Mar', 'Abr'],
          datasets: [{
            label: 'Gasto Acumulado',
            data: [12000, 31000, 46000, 72700],
            backgroundColor: 'rgba(255, 0, 0, 0.2)',
            borderColor: '#FF0000',
            borderWidth: 2,
            fill: true,
            tension: 0.1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                callback: function(value) {
                  return '$' + value.toLocaleString('es-AR');
                }
              }
            }
          }
        }
      });
    }
    
    // Llama a initCharts() cuando el DOM esté listo y los canvas existan
    document.addEventListener('DOMContentLoaded', function() {
      // ...existing code...
      if (
        document.getElementById('monthlyExpensesChart') &&
        document.getElementById('categoryPieChart') &&
        document.getElementById('cumulativeExpensesChart')
      ) {
        initCharts();
      }
      // ...existing code...
    });
  </script>
  </section>
  
</body>
</html>